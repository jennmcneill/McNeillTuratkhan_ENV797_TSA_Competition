---
title: "TSA: Part 2 of Kaggle competition"
author: "Jenn McNeill"
date: "04/01/2024"
output: pdf_document
always_allow_html: true
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: sentence
---

```{r}
library(lubridate)
library(ggplot2)
library(forecast)
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(zoo)
library(kableExtra)
library(readxl)
```

```{r load data}

load <- read_excel("./Data_NoGIT/Raw/load.xlsx")
humidity <- read_excel("./Data_NoGIT/Raw/relative_humidity.xlsx")
temperature <- read_excel("./Data_NoGIT/Raw/temperature.xlsx")
head(data)
head(humidity)
head(temperature)

``` 

```{r wrangle load data}

# create df with hourly values
hourly_data <- load %>%
  pivot_longer(h1:h24, names_to = "hour", values_to = "load") %>%
  mutate(hour = as.numeric(str_replace(hour, "h", ""))) %>%
  mutate(hour = hour - 1) %>%
  mutate(datetime = ymd_h(paste(date, hour, sep = " "))) %>%
  select(date, hour, datetime, load) 
  
# create df with daily averages
daily_data <- hourly_data %>%
  filter(!is.na(load)) %>%
  group_by(date) %>%
  summarise(average_load = mean(load))

# check for NAs
summary(hourly_data$load)
# there are 7 missing hourly values, so we will need to run tsclean if we are using hourly data to make a time series

summary(daily_data$average_load)
# there are no NAs in the daily average data, so we can make a time series without running the tsclean function

# plot the hourly values
ggplot(hourly_data, aes(x = datetime, y = load)) +
  geom_line() +
  ylab("Hourly Load")

# plot the daily averages
ggplot(daily_data, aes(x = date, y = average_load)) +
  geom_line() +
  ylab("Average Daily Load")

```

```{r wrangle temperature and humidity data}
  
# create df with daily temp averages
daily_temp <- temperature %>%
  pivot_longer(t_ws1:t_ws28, names_to = "site", values_to = "temperature") %>%
  group_by(date) %>%
  summarise(average_temp = mean(temperature))

# create df with daily relative humidity averages
daily_humidity <- humidity %>%
  pivot_longer(rh_ws1:rh_ws28, names_to = "site", values_to = "humidity") %>%
  group_by(date) %>%
  summarise(average_humidity = mean(humidity))

```


```{r create time series objects}

ts_load_hourly <- msts(hourly_data$load, 
                  seasonal.periods = c(24,168,8766), 
                  start = c(2005,1,1)) 
tsclean(ts_load_hourly)

ts_load_daily <- msts(daily_data$average_load, 
                 seasonal.periods = c(7,365.25),
                 start=c(2005,1,1))

ts_temp_daily <- msts(daily_temp$average_temp, 
                 seasonal.periods = c(7,365.25),
                 start=c(2005,1,1))

ts_humidity_daily <- msts(daily_humidity$average_humidity, 
                          seasonal.periods = c(7,365.25),
                          start=c(2005,1,1))
```

```{r decompose time series objects}

ts_load_hourly %>% 
  mstl() %>%
  autoplot()

ts_load_daily %>% 
  mstl() %>%
  autoplot()

```

```{r subset daily time series}

# create a subset of the time series that excludes one month
n_for = 31
ts_load_daily_training <- subset(ts_load_daily, end = length(ts_load_daily) - n_for)

# create a subset of the time series that only includes the last 365 days
ts_load_daily_testing <- subset(ts_load_daily, start = length(ts_load_daily) - n_for)

autoplot(ts_load_daily_training)
autoplot(ts_load_daily_testing)
```

```{r STL + ETS Model}

# fit and forecast STL + ETS model to data
ETS_fit <-  stlf(ts_load_daily_training, h = 31)

# plot foresting results
autoplot(ETS_fit) + 
  ylab("Daily Load") + 
  theme_light()

# plot model + observed data
autoplot(ts_load_daily, series = "Original") +
  autolayer(ETS_fit, series = "STL + ETS", PI = FALSE) +
  ylab("Daily Load") +
  theme_light()

# check the MAPE
STL_ETS_scores <- accuracy(ETS_fit$mean, ts_load_daily_testing)

STL_ETS_forecast <- ETS_fit$mean

getwd()
submission_template <- read.csv(file="./submission_template.csv", header=TRUE)
submission_template$date <- as.Date(submission_template$date, format = "%m/%d/%y")
submission_template$load <- STL_ETS_forecast
write.table(submission_template, "submission.csv", sep = ",", row.names = FALSE, quote = FALSE)

```




```{r ARIMA and Fourier Model 1}

ARIMA_Fourier_fit_1 <- auto.arima(ts_daily_training, 
                             seasonal = FALSE, 
                             lambda = 0,
                             xreg = fourier(ts_daily_training, 
                                            K=c(2,12)))

ARIMA_Fourier_forecast_1 <- forecast(ARIMA_Fourier_fit_1,
                                   xreg=fourier(ts_daily_training,
                                                K = c(2,12), h = 31), h=31) 

# plot foresting results
autoplot(ARIMA_Fourier_forecast_1) + 
  ylab("Daily Load") + 
  theme_light()

# plot model + observed data
autoplot(ts_daily, series = "Original") +
  autolayer(ARIMA_Fourier_forecast_1, series = "ARIMA FOURIER 1", PI = FALSE) +
  ylab("Daily Load") +
  theme_light()

# check the MAPE
ARIMA_Fourier_scores_1 <- accuracy(ARIMA_Fourier_forecast_1$mean, ts_daily_testing)
ARIMA_Fourier_scores_1

forecast_1 <- as.numeric(ARIMA_Fourier_forecast_1$mean)
print(forecast_1)

```


```{r ARIMA and Fourier Model 2}

ARIMA_Fourier_fit_2 <- auto.arima(ts_daily_training, 
                             seasonal = FALSE, 
                             lambda = 0,
                             xreg = fourier(ts_daily_training, 
                                            K=c(2,6)))

ARIMA_Fourier_forecast_2 <- forecast(ARIMA_Fourier_fit_2,
                                   xreg=fourier(ts_daily_training,
                                                K = c(2,6), h = 31), h=31) 

# plot foresting results
autoplot(ARIMA_Fourier_forecast_2) + 
  ylab("Daily Load") + 
  theme_light()

# plot model + observed data
autoplot(ts_daily, series = "Original") +
  autolayer(ARIMA_Fourier_forecast_2, series = "ARIMA FOURIER 2", PI = FALSE) +
  ylab("Daily Load") +
  theme_light()

# check the MAPE
ARIMA_Fourier_scores_2 <- accuracy(ARIMA_Fourier_forecast_2$mean, ts_daily_testing)
ARIMA_Fourier_scores_2

